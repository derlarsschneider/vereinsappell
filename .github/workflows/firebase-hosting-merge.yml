name: Deploy to Firebase Hosting on merge

on:
  push:
    branches:
    - main

jobs:
  build:
    runs-on: macos-latest

    env:
      ANDROID_APP_ID: 1:336568095877:android:f757f959bbe6c96be8c5ec
      IOS_APP_ID: 1:336568095877:ios:5b61a9b5162f57d1e8c5ec
      TESTER_GROUP: Schuetzenlust

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: stable
        flutter-version: 3.32.5

    - name: ğŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ğŸ•’ Set Version
      id: version
      run: |
        BUILD_NAME=$(date +"%y.%m.%d")
        BUILD_NUMBER=$(date +"%H%M")
        echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
        echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
        echo "ğŸ“¦ Version ist ${BUILD_NAME}+${BUILD_NUMBER}"

    - name: ğŸ“± Build Android APK
      run: ./build-scripts/build-apk.sh $BUILD_NAME $BUILD_NUMBER

    - name: ğŸ Build iOS App (no signing)
      run: ./build-scripts/build-ios.sh $BUILD_NAME $BUILD_NUMBER

    - name: ğŸ”¥ Setup Firebase CLI
      run: npm install -g firebase-tools

    - name: ğŸ” Authenticate Firebase CLI
      run: firebase login:ci --token "${{ secrets.FIREBASE_TOKEN }}"

    - name: ğŸš€ Distribute Android APK
      run: ./build-scripts/release-apk.sh $BUILD_NAME $BUILD_NUMBER $ANDROID_APP_ID $TESTER_GROUP

    - name: ğŸš€ Distribute iOS IPA
      run: ./build-scripts/release-ios.sh $BUILD_NAME $BUILD_NUMBER $IOS_APP_ID $TESTER_GROUP

    - uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: ${{ secrets.GITHUB_TOKEN }}
        firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_VEREINSAPPELL }}
        channelId: live
        projectId: vereinsappell
